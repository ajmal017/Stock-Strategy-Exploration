---
title: "Stock Automated Methodology"
author: "Paul, Karen, Abram"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: cerulean
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
## Setting RMD Project Directory
Project_Folder = rprojroot::find_rstudio_root_file()
knitr::opts_knit$set(root.dir = Project_Folder)

library(EmersonDataScience)

## Loading and Installing Packages if necessacary
Required_Packages = c('tidyverse','installr','psych','quantmod','lubridate','dygraphs','doParallel','XML','earth', 'googledrive','cumstats','dummy','knitr','xts','reshape2','mboost','glmnet','broom','recipes','caret','cluster','factoextra',"HiClimR","rpart","rpart.plot","caret")
load_or_install(Required_Packages)

## Loading Required Functions
sourceDir(paste0(Project_Folder,"/Codes/Functions"))

## Disabling API Warning
options("getSymbols.yahoo.warning" = FALSE)
options("getSymbols.warning4.0" = FALSE)

## General RMD Options
Re_Pull = T
Initial_History = F
TEST = F
Back_Test = F
```

### {.tabset}

```{r Raw Data Pull, include = F,eval = !TEST}
## Pulling Historical Data
if(Re_Pull){
  ## Fresh Historical Data Pull
  Initial_Pull()
}else{
  ## Historical Table Update
  Ticker_Pull_Function(Location = paste0(Project_Folder,"/Data/"),
                       Google_Drive = F)
}
```

#### Market Status

```{r Market Direction, echo = F,message = F, warning = F,fig.align='center',fig.asp = 0.5625,fig.width = 10}
## Loading Historical Stock Data
load(paste0(Project_Folder,"/Data/NASDAQ Historical.RDATA"))
Combined_Results = Combined_Results %>%
  filter(Date != Sys.Date())

## Bear/Bull Calculations
Market_Ind = Market_Direction(Combined_Results)
## General Fear Calculations
Fear_Ind = Fear_Direction(Combined_Results,Market_Ind)

## Saving Market Indicators
save(Market_Ind,Fear_Ind,
     file = paste0(Project_Folder,"/Data/Market Direction.RDATA"))
```
  
```{r Appending Stats and Indicators,include = F,eval = !TEST}
## Normalizing OHLCV Values  
Start = Sys.time()
print("Initial Stat Calculation for Pool Selection")
PR_Stage = PR_Appendage(Combined_Results,parallel = T)
Sys.time() - Start

## Compairing Performance to Major Indexs
Major_Indexs = c("^GSPC","^IXIC","^DJI")
Index_Alpha_Slope = PR_Stage %>%
  filter(Stock %in% Major_Indexs) %>%
  select(Stock,Date,Close_Slope_50_Norm) %>%
  spread(Stock,Close_Slope_50_Norm) %>%
  mutate(Alpha_Slope = rowMeans(cbind(`^GSPC`,`^IXIC`,`^DJI`))) %>%
  select(Date,Alpha_Slope)

## Appending Results
PR_Stage_R2 = PR_Stage %>%
  left_join(Index_Alpha_Slope,by = "Date") %>%
  na.omit() %>%
  mutate(Pseudo_Alpha_PD = (Close_Slope_50_Norm - Alpha_Slope)/Alpha_Slope) %>%
  filter_all(all_vars(!is.infinite(.)))


## Removing Dead Stocks Or Baby Stocks
Time_Stop = max(PR_Stage_R2$Date)
Time_Start = Time_Stop - 365*5
Last_Time = PR_Stage_R2 %>% 
  group_by(Stock) %>%
  summarise(Max_Time = max(Date),
            Min_Time = min(Date)) %>%
  filter(Max_Time == Time_Stop,
         Min_Time <= Time_Start)

## Calculating Technical Indicators
Stocks = unique(Last_Time$Stock)

## Spinning Up Clusters
pb <- txtProgressBar(max = length(Stocks), style = 3)
progress <- function(n) setTxtProgressBar(pb, n)
opts <- list(progress = progress)
library(doSNOW)
c1 = makeCluster(10,outfile = "")
registerDoSNOW(c1)

## Parallel Execution
Results = foreach(i = 1:length(Stocks),
                  .inorder = F,
                  .packages = c("tidyverse",
                                "quantmod",
                                "lubridate",
                                "TTR"),
                  .verbose = F,
                  .options.snow = opts) %dopar% {
                    ## Subsetting Data
                    TMP = PR_Stage_R2 %>%
                      filter(Stock == Stocks[i])
                    
                    ## Calculating Technical Indicators
                    Stat_Appendage_Function(DF = TMP)
                  }

## Spinning Down Clusters
stopCluster(c1)
registerDoSEQ()

## Consolidating Results
PR_Stage_R3 = plyr::ldply(Results,data.frame)

## Saving Results
save(PR_Stage_R3,
     file = paste0(Project_Folder,"/Data/Normalized Historical and Technical Indicators.RDATA"))
```

```{r Variable Importance Reduction, include = F,eval = !TEST}
## Loading Indicator Data
load(file = paste0(Project_Folder,"/Data/Market Direction.RDATA"))
load(file = paste0(Project_Folder,"/Data/Normalized Historical and Technical Indicators.RDATA"))

## Initial Data
ID_DF = PR_Stage_R3 %>%
  left_join(Market_Ind) %>%
  left_join(Fear_Ind) %>%
  mutate(WAD_Delta = WAD - lag(WAD,1),
         Close_PD = (Close - lag(Close,1))/lag(Close,1),
         SMI_Delta = (SMI - lag(SMI,1)),
         SMI_Sig_Delta = (SMI_Signal - lag(SMI_Signal,1)),
         CCI_Delta = (CCI - lag(CCI,1)),
         VHF_Delta = (VHF - lag(VHF,1)))

## Defining Target Variable
PR_Stage_R4 = PR_Stage_R3 %>%
  group_by(Stock) %>%
  mutate(Adjusted_Lead = lead(Close,15),
         PD_Lead = (Adjusted_Lead - Adjusted)/Adjusted,
         Target = ifelse(PD_Lead > 0,1,0),
         Adjusted_Lead = PD_Lead) %>%
   mutate(WAD_Delta = WAD - lag(WAD,1),
         Close_PD = (Close - lag(Close,1))/lag(Close,1),
         SMI_Delta = (SMI - lag(SMI,1)),
         SMI_Sig_Delta = (SMI_Signal - lag(SMI_Signal,1)),
         CCI_Delta = (CCI - lag(CCI,1)),
         VHF_Delta = (VHF - lag(VHF,1))) %>%
  ungroup() %>%
  select(-c(PD_Lead)) %>%
  na.omit() %>%
  filter(!str_detect(Stock,"^\\^"))

Models = Modeling_Function(PR_Stage_R4 = PR_Stage_R4,
                           Max_Date = max(PR_Stage_R4$Date))

TODAY = ID_DF %>%
  filter(Date == max(Date))

PREDS = Prediction_Function(Models = Models,
                            TODAY = TODAY,
                            FinViz = F)
RESULT = PREDS$RESULT %>%
  head(10)
FUTURES = PREDS$FUTURES
SHORTS = PREDS$SHORTS

save(RESULT,FUTURES,SHORTS,TODAY,PR_Stage_R4,ID_DF,Models,
     file = paste0(Project_Folder,"/data/Report Outputs.RDATA"))
```

#### Potential Buy Position

```{r,echo = F}
load(file = paste0(Project_Folder,"/data/Report Outputs.RDATA"))
load(file = paste0(Project_Folder,"/Data/Normalized Historical and Technical Indicators.RDATA"))
load(paste0(Project_Folder,"/Data/NASDAQ Historical.RDATA"))
load(file = paste0(Project_Folder,"/Data/Market Direction.RDATA"))

DT::datatable(mutate_if(RESULT,is.numeric,round,3),
              rownames = F,
              options = list(autoWidth = T))
```

#### Monitoring Charts

```{r Charts,echo = F,fig.align='center',fig.asp = 0.5625,fig.width = 10}
## Plotting last 6 Months of Stock Data
Tickers = unique(RESULT$Stock)
Plot_Date = max(Combined_Results$Date) - 30*3
if(nrow(RESULT) > 0){
  for(i in 1:length(Tickers)){
    TMP = Combined_Results %>%
      filter(Stock == Tickers[i]) %>%
      mutate(Color = ifelse(Close > Open,"Gain","Loss"),
             Date = as_date(Date)) %>%
      melt(id.vars = c("Date","Stock","Color")) %>%
      group_by(variable) %>%
      mutate(SMA_50 = rollapply(value,
                                width = 50,
                                FUN = mean,
                                na.rm = T,
                                fill = NA,
                                align = "right"),
             SMA_200 = rollapply(value,
                                 width = 200,
                                 FUN = mean,
                                 na.rm = T,
                                 fill = NA,
                                 align = "right")) %>%
      ungroup() %>%
      na.omit() %>%
      filter(Date >= Plot_Date,
             variable %in% c("Close","Volume"))
    Current_Price = TMP %>%
      filter(variable == "Close",
             Date == max(Date))
    
    
    p1 = ggplot(TMP,aes(x = Date,y = value)) +
      geom_line() +
      geom_line(aes(y = SMA_50),linetype = 3,size = 1) +
      geom_line(aes(y = SMA_200), linetype = 2,size = 1)+
      scale_x_date(breaks = scales::pretty_breaks(9)) +
      scale_color_manual(values = c("green","red")) +
      labs(title = paste0(unique(TMP$Stock)," 3 Month Performance :: Current Price = ",round(Current_Price$value,2)),
           subtitle = "Dotted Line = 50 Day SMA :: Dashed Line = 200 Day SMA :: Solid Line = Actual",
           y = "",
           x = "",
           color = "") +
      theme(legend.position = "none",
            axis.text.y = element_blank(),axis.ticks.y = element_blank()) +
      facet_wrap(variable~.,nrow = 2,scales = "free_y")
    print(p1)
  }
}
```

#### Stock's With Positive Futures

```{r,echo = F}
load(file = paste0(Project_Folder,"/data/Report Outputs.RDATA"))
DT::datatable(mutate_if(FUTURES,is.numeric,round,3),
              options = list(autoWidth = T),
              rownames = F)
```

#### Stock's With Negative Futures

```{r,echo = F}
load(file = paste0(Project_Folder,"/data/Report Outputs.RDATA"))
DT::datatable(mutate_if(SHORTS,is.numeric,round,3),
              options = list(autoWidth = T),
              rownames = F)
```

#### Historical Back Test

* Run for most recent years worth of data
* Models Updated Every 30 Days
    + Futures model predicts 6wk percentage delta
        - Regression model
    + Profit model predicts probabiltiy of a 6wk positive return
        - Logistic regression model
    + Training observations weighted decaying with time
* Selection Criteria
    + Stock did not just reach a new high
    + Volatility > 0.055
    + Risk < median(Risk) - 3*mad(Risk)
        - Risk being the delta between predicted 6wk future and stop loss percentage
        - Stop loss is adjusted - 2*ATR and updated daily if above previous

```{r Historical Back Test, echo = F, message=F,warning=F}
if(Back_Test){
  Starting_Money = 10000
  Max_Holding = 0.05
  Max_Stocks = floor(1/Max_Holding)
  Max_Loss = 0.05
  Start = sample(seq(1,length(unique(PR_Stage_R4$Date)) - 260),1)
  Delta = as.numeric(max(PR_Stage_R3$Date) - max(PR_Stage_R4$Date))
  Dates = sort(unique(PR_Stage_R4$Date))[Start:(Start+252)]
  IP = Combined_Results$Close[Combined_Results$Stock == "^GSPC" &
                                    Combined_Results$Date == Dates[1]+ Delta + 6]
  FP = Combined_Results$Close[Combined_Results$Stock == "^GSPC" &
                                    Combined_Results$Date == Dates[length(Dates)] + Delta + 6]
  (MR = scales::percent((FP-IP)/IP))
  
  ## Building Initial Models
  Models = Modeling_Function(PR_Stage_R4 = filter(PR_Stage_R4,
                                                  Volatility_Satchell > 0.10,
                                                  Volatility_Satchell < 0.50,
                                                  DIL > 15,
                                                  DIL < 60,
                                                  SMI_Signal > -50,
                                                  SMI_Signal < 50,
                                                  DI > -875,
                                                  DI < 275),
                             Max_Date = ymd(as.character(Dates[1])))

  counter = 0
  p = progress_estimated(length(Dates))
  for(i in 1:length(Dates)){
    Current_Date = as.character(Dates[i]+Delta)
    TODAY = ID_DF %>%
      filter(Date == Current_Date)
    
    ## Periodically Checking Positions
    if(nrow(TODAY) > 0){
      Preds = Prediction_Function(Models,
                                  TODAY = TODAY,
                                  FinViz = F)
      RESULT = Preds$RESULT %>%
        filter(Volatility_Satchell > 0.10,
               Volatility_Satchell < 0.50,
               DIL > 15,
               DIL < 60,
               SMI_Signal > -50,
               SMI_Signal < 50,
               DI > -875,
               DI < 275)
      FUTURES = Preds$FUTURES
      SHORTS = Preds$SHORTS
    }
      
      if(nrow(RESULT) > 0 & counter == 0){
        counter = counter + 1
        History_Table = Performance_Function(PR_Stage_R3 = PR_Stage_R3,
                                             RESULT = RESULT,
                                             FUTURES = FUTURES,
                                             SHORTS = SHORTS,
                                             Starting_Money = Starting_Money,
                                             Max_Holding = Max_Holding,
                                             Max_Stocks = Max_Stocks,
                                             Max_Loss = Max_Loss,
                                             Current_Date = Current_Date,
                                             Projection = 15,
                                             Initial_History = ifelse(counter == 1,T,F),
                                             History_Location = paste0(Project_Folder,"/data/Back Test.RDATA"))
      }else{
         counter = counter + 1
         Result =  tryCatch({
           History_Table = 
             Performance_Function(PR_Stage_R3 = PR_Stage_R3,
                                  RESULT = RESULT,
                                  FUTURES = FUTURES,
                                  SHORTS = SHORTS,
                                  Starting_Money = Starting_Money,
                                  Max_Holding = Max_Holding,
                                  Max_Stocks = Max_Stocks,
                                  Max_Loss = Max_Loss,
                                  Current_Date = Current_Date,
                                  Projection = 15,
                                  Initial_History = ifelse(counter == 1,T,F),
                                  History_Location = paste0(Project_Folder,
                                                            "/data/Back Test.RDATA"))
         }, warning = function(w){
           print(w)
         }, error = function(e){
           print("Encountered a Non-Trading Day")
         }, finally = {
         })
         if(all(class(Result) == "data.frame")){
           History_Table = Result
         }
      }
    p$pause(0.1)$tick()$print()
  }
}
print("S&P Market Return")
(MR = scales::percent((FP-IP)/IP))

## Loading Previously Stored Back Test
load(file = paste0(Project_Folder,"/data/Back Test.RDATA"))

History_Table = History_Table %>%
  select(Prob,Delta,everything())

## Adding Additional Technical Indicators
Explore = History_Table %>%
    filter(Pcent.Gain != 0,
           !is.na(Sell.Date)) %>%
    left_join(Market_Ind) %>%
    left_join(Fear_Ind) %>%
    mutate(Positive = ifelse(Pcent.Gain > 0,1,0),
           Pcent_Adj = Pcent.Gain/Time.Held,
           Good = case_when(
             Max.Price > Buy.Price ~ 1,
             T ~ 0
           )) %>%
  select_if(is.numeric) %>%
  select(-contains("MAX_")) %>%
  filter(!is.infinite(Pcent_Adj)) %>%
  select(Good,Pcent_Adj,Positive,Volatility_Satchell,everything())

Var = "DI"
counter = 0
for(i in seq(min(Explore[,Var]),max(Explore[,Var]),length.out = 100)){
  counter = counter + 1
  Keep_Low = which(Explore[,Var] < i)
  Keep_High = which(Explore[,Var] > i)
  TMP_Low = History_Table[Keep_Low,]
  P_TL = sum(TMP_Low$Profit) + 
    sum(TMP_Low$Buy.Price[is.na(TMP_Low$Sell.Date)] *
          TMP_Low$Pcent.Gain[is.na(TMP_Low$Sell.Date)] *
          TMP_Low$Number[is.na(TMP_Low$Sell.Date)])
  TMP_High = History_Table[Keep_High,]
  P_TH = sum(TMP_High$Profit) + 
    sum(TMP_High$Buy.Price[is.na(TMP_High$Sell.Date)] *
          TMP_High$Pcent.Gain[is.na(TMP_High$Sell.Date)] *
          TMP_High$Number[is.na(TMP_High$Sell.Date)])
  if(counter == 1){
    PL = P_TL
    VL = i
    PH = P_TH
    VH = i
  }else{
    if(P_TL > PL){
      PL = P_TL
      VL = i
    }
    if(P_TH > PH){
      PH = P_TH
      VH = i
    }
  }
}
print(Var)
print(paste0("Low Side Value < ",round(VL,4),
             " Profit = ",round(PL,4)))

print(paste0("High Side Value > ",round(VH,4),
             " Profit = ",round(PH,4)))
COR = cor(Explore)

Method_Refine = rpart(Positive~.,
                      data = select(Explore,
                                -c(Good,Profit,Number,Buy.Price,
                                   Max.Price,Stop.Loss,Time.Held,Pcent.Gain,
                                   chaikin_AD,Pcent_Adj)),
                      method = "class",
                      control = rpart.control(maxdepth = 2),
                      model = T)
rpart.plot(Method_Refine)

write_excel_csv(Explore,
                path = "C://users//aayorde//desktop//BackTest.CSV")

## Calculating Historical Return
Historical_Return = scales::percent(sum(History_Table$Pcent.Gain*History_Table$Buy.Price)/sum(History_Table$Buy.Price))
                                                       
## Interactive Table of Buy History
DT::datatable(data = mutate_if(History_Table,is.numeric,round,3),
              filter = list(position = 'top',
                            autoWidth = T),
              rownames = F)
```

##### Historical Return `r Historical_Return`

#### Performance History

```{r Perf History, echo = F,message = F,warning=F}
load(file = paste0(Project_Folder,"/data/Report Outputs.RDATA"))
History_Table = Performance_Function(PR_Stage_R3 = PR_Stage_R3,
                                     RESULT = RESULT,
                                     FUTURES = FUTURES,
                                     Current_Date = getmode(TODAY$Date),
                                     Fear_Marker = getmode(TODAY$Fear_Extent),
                                     Initial_History = Initial_History)

# Printing Historical Returns
Historical_Return = scales::percent(sum(History_Table$Pcent.Gain*History_Table$Buy.Price)/
                                      sum(History_Table$Buy.Price) * 
                                      (365 /
                                         (as.numeric(max(History_Table$Buy.Date) - 
                                                       min(History_Table$Buy.Date)))))

## Interactive Table of Buy History
DT::datatable(data = mutate_if(History_Table,is.numeric,round,3),
              filter = list(position = 'top',
                            autoWidth = T),
              rownames = F)
```

##### Historical Return `r Historical_Return`

